<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MEG Carwash – Café • Carwash • Gym</title>
  <!-- NOTE: untuk demo cepat. Untuk production, install Tailwind via CLI/PostCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .container { max-width: 1100px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- HEADER -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center p-4">
      <h1 class="text-2xl font-bold">MEG Carwash</h1>
      <nav class="space-x-4 hidden md:block">
        <a href="#menuCafe" class="hover:text-green-600">Café</a>
        <a href="#carwash" class="hover:text-green-600">Carwash</a>
        <a href="#gym" class="hover:text-green-600">Gym</a>
        <a href="#membership" class="hover:text-green-600">Membership</a>
        <a href="#booking" class="hover:text-green-600">Booking</a>
        <a href="#admin" class="hover:text-red-600">Admin</a>
      </nav>
    </div>
  </header>

  <!-- HERO (pakai gambar stabil/valid) -->
  <section class="relative bg-cover bg-center h-[60vh]"
           style="background-image:url('https://images.unsplash.com/photo-1542362567-b07e54358753')">
    <div class="bg-black/50 h-full flex items-center justify-center">
      <div class="text-center text-white">
        <h2 class="text-4xl md:text-5xl font-bold mb-4">Café • Carwash • Gym</h2>
        <p class="text-lg mb-6">Semua dalam satu tempat – MEG Carwash</p>
        <a href="#booking" class="bg-green-600 px-6 py-3 rounded-lg text-white font-semibold hover:bg-green-700">
          Booking Sekarang
        </a>
      </div>
    </div>
  </section>

  <!-- MENU CAFE -->
  <section id="menuCafe" class="py-12 bg-gray-50">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6 text-center">Menu Café</h2>
      <div id="cafe-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </div>
  </section>

  <!-- CARWASH -->
  <section id="carwash" class="py-12">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6 text-center">Paket Carwash</h2>
      <div id="carwash-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </div>
  </section>

  <!-- GYM -->
  <section id="gym" class="py-12 bg-gray-50">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6 text-center">Paket Gym</h2>
      <div id="gym-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </div>
  </section>

  <!-- MEMBERSHIP -->
  <section id="membership" class="py-12">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl font-bold mb-6">Cek Membership</h2>
      <div class="max-w-xl mx-auto">
        <input type="text" id="memberQuery" placeholder="Masukkan No. HP atau ID Member"
               class="border p-3 rounded w-full mb-4">
        <button id="btnFindMember"
                class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Cek</button>
      </div>
      <div id="member-result" class="mt-6 text-lg"></div>
    </div>
  </section>

  <!-- BOOKING -->
  <section id="booking" class="py-12 bg-gray-50">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6 text-center">Booking</h2>
      <form id="bookingForm" class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
        <input type="text" name="nama" placeholder="Nama" class="border p-2 rounded w-full mb-3" required>
        <input type="text" name="hp" placeholder="No. HP" class="border p-2 rounded w-full mb-3" required>
        <select name="layanan" class="border p-2 rounded w-full mb-3" required>
          <option value="">Pilih Layanan</option>
          <option value="Carwash">Carwash</option>
          <option value="Gym">Gym</option>
        </select>
        <input type="date" name="tanggal" class="border p-2 rounded w-full mb-3" required>
        <input type="time" name="jam" class="border p-2 rounded w-full mb-3" required>
        <textarea name="catatan" placeholder="Catatan" class="border p-2 rounded w-full mb-3"></textarea>
        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Kirim Booking</button>
      </form>
      <div id="booking-result" class="mt-6 text-center"></div>
    </div>
  </section>

  <!-- TESTIMONI -->
  <section id="testimoni" class="py-12">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6 text-center">Testimoni</h2>
      <div id="testimoni-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </div>
  </section>

  <!-- GALERI -->
  <section id="galeri" class="py-12 bg-gray-50">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6 text-center">Galeri</h2>
      <div id="galeri-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </div>
  </section>

  <!-- ADMIN PANEL -->
  <section id="admin" class="py-12">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6 text-center">Admin Panel</h2>
      <div id="admin-login" class="text-center">
        <input type="password" id="admin-pin" placeholder="Masukkan PIN Admin" class="border p-2 rounded mb-4">
        <button id="btnAdminLogin" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Login</button>
      </div>
      <div id="admin-panel" class="hidden">
        <div class="mb-4">
          <select id="admin-sheet" class="border p-2 rounded">
            <option value="MenuCafe">Menu Café</option>
            <option value="PaketCarwash">Paket Carwash</option>
            <option value="PaketGym">Paket Gym</option>
          </select>
          <button id="btnLoadAdmin" class="ml-2 bg-green-600 text-white px-4 py-2 rounded">Load Data</button>
        </div>
        <div id="admin-table" class="overflow-x-auto mb-6"></div>
        <h3 class="text-xl font-bold mb-2">Tambah / Edit Data</h3>
        <form id="adminForm" class="bg-white p-4 rounded shadow space-y-3">
          <input type="hidden" id="admin-id">
          <input type="text" id="admin-nama" placeholder="Nama" class="border p-2 rounded w-full">
          <input type="text" id="admin-harga" placeholder="Harga" class="border p-2 rounded w-full">
          <input type="text" id="admin-hargaCoret" placeholder="Harga Coret" class="border p-2 rounded w-full">
          <input type="text" id="admin-deskripsi" placeholder="Deskripsi" class="border p-2 rounded w-full">
          <input type="text" id="admin-img" placeholder="Link Gambar (khusus Menu Café)" class="border p-2 rounded w-full">
          <div class="flex gap-2">
            <button type="button" id="btnSaveData" class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button>
            <button type="button" id="btnResetAdmin" class="bg-gray-400 text-white px-4 py-2 rounded">Reset</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="bg-gray-800 text-white py-6 text-center">
    <p>&copy; 2025 MEG Carwash. All Rights Reserved.</p>
  </footer>

  <!-- SCRIPT -->
  <script>
    // ====== KONFIGURASI API ======
    const API_URL = "https://script.google.com/macros/s/AKfycbydl4_bKwUdo37UVRoMUXpkEGuH3ymaybyFuDQZhpd-V4BhOTzkwhXMsyKha7ijZxGR/exec";
    const API_TOKEN = "AKfycbydl4_bKwUdo37UVRoMUXpkEGuH3ymaybyFuDQZhpd-V4BhOTzkwhXMsyKha7ijZxGR";
    const ADMIN_PIN = "1234"; // demo only (untuk produksi, validasi di server)

    // ====== HELPER: Fetch aman (tahan Unauthorized / non-JSON) ======
    async function fetchJSONSafe(url, options = {}) {
      try {
        const res = await fetch(url, options);
        const text = await res.text();
        // Coba parse JSON
        try {
          const json = JSON.parse(text);
          return json;
        } catch (e) {
          // Jika bukan JSON, kembalikan error yang bisa ditampilkan
          return { success: false, error: text || ("HTTP " + res.status) };
        }
      } catch (err) {
        return { success: false, error: err.message || "Network error" };
      }
    }

    // ====== UI Helper ======
    function currency(n){ if(n === "" || n === undefined || n === null) return ""; const num = Number(n); return isNaN(num) ? n : "Rp " + num.toLocaleString(); }
    function el(id){ return document.getElementById(id); }

    // ====== LOAD DATA PUBLIC ======
    async function loadCafeMenu() {
      const data = await fetchJSONSafe(`${API_URL}?action=list&sheet=MenuCafe&token=${API_TOKEN}`);
      const list = el("cafe-list");
      list.innerHTML = "";
      if (data.success === false && data.error) {
        list.innerHTML = `<p class="text-red-600">Gagal load Menu Café: ${data.error}</p>`;
        return;
      }
      (data || []).forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-white shadow-lg rounded-xl overflow-hidden hover:shadow-xl transition";
        card.innerHTML = `
          <img src="${item.img || 'https://via.placeholder.com/400x250?text=No+Image'}" alt="${item.nama || ''}" class="w-full h-48 object-cover">
          <div class="p-4">
            <h3 class="text-lg font-bold">${item.nama || ''}</h3>
            <p class="text-sm text-gray-500 mb-2">${item.deskripsi || ''}</p>
            <div class="flex items-center justify-between">
              <span class="text-xl font-semibold text-green-600">${currency(item.harga)}</span>
              ${item.hargaCoret ? `<span class="line-through text-gray-400">${currency(item.hargaCoret)}</span>` : ""}
            </div>
          </div>`;
        list.appendChild(card);
      });
    }

    async function loadCarwash() {
      const data = await fetchJSONSafe(`${API_URL}?action=list&sheet=PaketCarwash&token=${API_TOKEN}`);
      const list = el("carwash-list");
      list.innerHTML = "";
      if (data.success === false && data.error) {
        list.innerHTML = `<p class="text-red-600">Gagal load Carwash: ${data.error}</p>`;
        return;
      }
      (data || []).forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow hover:shadow-lg transition";
        card.innerHTML = `
          <h3 class="text-lg font-bold">${item.nama || ''}</h3>
          <p class="text-sm text-gray-500 mb-2">${item.deskripsi || ''}</p>
          <span class="text-xl font-semibold text-green-600">${currency(item.harga)}</span>
          ${item.hargaCoret ? `<span class="line-through text-gray-400 ml-2">${currency(item.hargaCoret)}</span>` : ""}`;
        list.appendChild(card);
      });
    }

    async function loadGym() {
      const data = await fetchJSONSafe(`${API_URL}?action=list&sheet=PaketGym&token=${API_TOKEN}`);
      const list = el("gym-list");
      list.innerHTML = "";
      if (data.success === false && data.error) {
        list.innerHTML = `<p class="text-red-600">Gagal load Gym: ${data.error}</p>`;
        return;
      }
      (data || []).forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow hover:shadow-lg transition";
        card.innerHTML = `
          <h3 class="text-lg font-bold">${item.nama || ''}</h3>
          <p class="text-sm text-gray-500 mb-2">${item.deskripsi || ''}</p>
          <span class="text-xl font-semibold text-green-600">${currency(item.harga)}</span>
          ${item.hargaCoret ? `<span class="line-through text-gray-400 ml-2">${currency(item.hargaCoret)}</span>` : ""}`;
        list.appendChild(card);
      });
    }

    async function doFindMember() {
      const q = el("memberQuery").value.trim();
      if (!q) return;
      const data = await fetchJSONSafe(`${API_URL}?action=find.member&q=${encodeURIComponent(q)}&token=${API_TOKEN}`);
      const result = el("member-result");
      if (data && data.nama) {
        result.innerHTML = `<p><strong>${data.nama}</strong> (${data.tier})<br>Berlaku sampai: ${data.berlaku_sampai}</p>`;
      } else if (data.success === false && data.error) {
        result.innerHTML = `<p class="text-red-600">${data.error}</p>`;
      } else {
        result.innerHTML = `<p class="text-red-600">Member tidak ditemukan</p>`;
      }
    }

    async function submitBooking(e) {
      e.preventDefault();
      const form = e.target;
      const payload = Object.fromEntries(new FormData(form));
      const data = await fetchJSONSafe(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "booking.create", sheet: "Bookings", token: API_TOKEN, data: payload })
      });
      el("booking-result").innerHTML = (data && data.success)
        ? "<p class='text-green-600'>Booking berhasil!</p>"
        : `<p class='text-red-600'>Booking gagal: ${(data && data.error) ? data.error : 'unknown error'}</p>`;
      if (data && data.success) form.reset();
    }

    async function loadTestimoni() {
      const data = await fetchJSONSafe(`${API_URL}?action=list&sheet=Testimoni&token=${API_TOKEN}`);
      const list = el("testimoni-list");
      list.innerHTML = "";
      if (data.success === false && data.error) {
        list.innerHTML = `<p class="text-red-600">Gagal load Testimoni: ${data.error}</p>`;
        return;
      }
      (data || []).forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow hover:shadow-lg transition text-center";
        card.innerHTML = `
          <img src="${item.foto || 'https://via.placeholder.com/100'}" class="w-16 h-16 rounded-full mx-auto mb-3">
          <p class="italic">"${item.komentar || ''}"</p>
          <h4 class="mt-2 font-bold">${item.nama || ''}</h4>`;
        list.appendChild(card);
      });
    }

    async function loadGaleri() {
      const data = await fetchJSONSafe(`${API_URL}?action=list&sheet=Galeri&token=${API_TOKEN}`);
      const list = el("galeri-list");
      list.innerHTML = "";
      if (data.success === false && data.error) {
        list.innerHTML = `<p class="text-red-600">Gagal load Galeri: ${data.error}</p>`;
        return;
      }
      (data || []).forEach(item => {
        const card = document.createElement("div");
        card.innerHTML = `<img src="${item.url}" alt="${item.alt || ''}" class="rounded-lg shadow w-full h-44 object-cover">`;
        list.appendChild(card);
      });
    }

    // ====== ADMIN ======
    function adminLogin() {
      const pin = el("admin-pin").value.trim();
      if (pin === ADMIN_PIN) {
        el("admin-login").classList.add("hidden");
        el("admin-panel").classList.remove("hidden");
      } else {
        alert("PIN salah!");
      }
    }

    async function loadAdminData() {
      const sheet = el("admin-sheet").value;
      const data = await fetchJSONSafe(`${API_URL}?action=list&sheet=${encodeURIComponent(sheet)}&token=${API_TOKEN}`);
      const tableDiv = el("admin-table");
      if (data && data.success === false && data.error) {
        tableDiv.innerHTML = `<p class="text-red-600">${data.error}</p>`;
        return;
      }
      let html = `<table class="min-w-full border text-sm"><thead><tr>`;
      if ((data || []).length > 0) {
        Object.keys(data[0]).forEach(k => { html += `<th class="border px-2 py-1 bg-gray-100">${k}</th>`; });
        html += `<th class="border px-2 py-1 bg-gray-100">Aksi</th></tr></thead><tbody>`;
        data.forEach(row => {
          html += `<tr>`;
          Object.values(row).forEach(v => { html += `<td class="border px-2 py-1 align-top">${v ?? ""}</td>`; });
          html += `<td class="border px-2 py-1">
            <button class="text-blue-600 mr-2" onclick='editData(${JSON.stringify(row).replace(/'/g,"&#39;")})'>Edit</button>
            ${row.id ? `<button class="text-red-600" onclick='deleteData("${sheet}","${String(row.id).replace(/"/g,"&quot;")}")'>Hapus</button>` : ""}
          </td>`;
          html += `</tr>`;
        });
        html += `</tbody></table>`;
      } else {
        html = "<p>Belum ada data</p>";
      }
      tableDiv.innerHTML = html;
    }

    function editData(row) {
      el("admin-id").value = row.id || "";
      el("admin-nama").value = row.nama || "";
      el("admin-harga").value = row.harga || "";
      el("admin-hargaCoret").value = row.hargaCoret || "";
      el("admin-deskripsi").value = row.deskripsi || "";
      el("admin-img").value = row.img || "";
    }

    async function saveData() {
      const sheet = el("admin-sheet").value;
      const id = el("admin-id").value.trim();
      const data = {
        nama: el("admin-nama").value,
        harga: el("admin-harga").value,
        hargaCoret: el("admin-hargaCoret").value,
        deskripsi: el("admin-deskripsi").value,
        img: el("admin-img").value,
      };
      const payload = { action: id ? "update" : "create", sheet, token: API_TOKEN, id, data };
      const res = await fetchJSONSafe(API_URL, { method: "POST", body: JSON.stringify(payload) });
      if (res && res.success) {
        alert("Data tersimpan");
        resetAdminForm();
        loadAdminData();
        // Refresh list publik
        loadCafeMenu(); loadCarwash(); loadGym();
      } else {
        alert("Gagal simpan: " + ((res && res.error) ? res.error : "unknown error"));
      }
    }

    async function deleteData(sheet, id) {
      if (!confirm("Yakin hapus data ini?")) return;
      const res = await fetchJSONSafe(API_URL, { method: "POST", body: JSON.stringify({ action: "delete", sheet, token: API_TOKEN, id }) });
      if (res && res.success) {
        alert("Data terhapus");
        loadAdminData();
        loadCafeMenu(); loadCarwash(); loadGym();
      } else {
        alert("Gagal hapus: " + ((res && res.error) ? res.error : "unknown error"));
      }
    }

    function resetAdminForm() {
      el("admin-id").value = "";
      el("adminForm").reset();
    }

    // ====== EVENT BINDING ======
    document.addEventListener("DOMContentLoaded", () => {
      loadCafeMenu();
      loadCarwash();
      loadGym();
      loadTestimoni();
      loadGaleri();

      el("bookingForm").addEventListener("submit", submitBooking);
      el("btnFindMember").addEventListener("click", doFindMember);
      el("btnAdminLogin").addEventListener("click", adminLogin);
      el("btnLoadAdmin").addEventListener("click", loadAdminData);
      el("btnSaveData").addEventListener("click", saveData);
      el("btnResetAdmin").addEventListener("click", resetAdminForm);
    });
  </script>
</body>
</html>
